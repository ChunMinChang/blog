I"‘<p>To calculate the duration of one <em>MP3</em> file,
we need to know how it is encoded first.
The estimation of durtation is different
based on how they are encoded.</p>

<h2 id="cbrconstant-bitrate-vs-vbrvariable-bitrate-encoding">CBR(Constant Bitrate) vs VBR(Variable Bitrate) Encoding</h2>

<p><em>MP3</em> can be encoded either with <strong>constant bitrate</strong>(<strong>CBR</strong>)
or <strong>variable bitrate</strong>(<strong>VBR</strong>).
The quality of the <em>MP3</em> encoded with <em>VBR</em> is better than one with <em>CBR</em>
since each frame can adopt different bitrate where the music needs it,
while the <em>CBR</em> file uses same bitrate regardless of what sound wave is.</p>

<h2 id="how-to-know-whether-the-file-is-cbr-or-vbr">How to know whether the file is CBR or VBR</h2>

<p><em>MP3</em> header has two types: <strong>Xing</strong> and <strong>VBRI</strong>.
The <em>ID</em> of the <em>Xing</em> header is either <strong>Xing</strong> or <strong>Info</strong>;
The <em>ID</em> labelled to <strong>VBRI</strong> is <em>VBRI</em> header.</p>

<p>The <em>ID</em> of <em>Xing</em> header marked with <strong>Info</strong>
is definitely encoded with <em>CBR</em>.
Nonetheless, assigning <em>Xing</em> as the header ID of a <em>CBR</em> file
is logically acceptable because <em>CBR</em> is a special case of <em>VBR</em>.</p>

<h2 id="how-to-estimate-the-duration">How to estimate the duration</h2>

<h3 id="cbrconstant-bitrate">CBR(Constant Bitrate)</h3>

<p>The calculation for <em>CBR</em> <em>MP3</em> is straightforward:</p>

<script type="math/tex; mode=display">\text{Duration (seconds)} = \frac{ \text{File Size (bits)} }{ \text{Bitrate (bits/second)} }</script>

<p>The unit of <em>file size</em> is usually <em>bytes</em>,
so the <em>bit size</em> of the file is <code class="highlighter-rouge">file size(bytes) * 8</code>.</p>

<h3 id="vbrvariable-bitrate">VBR(Variable Bitrate)</h3>

<p>The calculation for <em>VBR</em> <em>MP3</em> is a little complicated:</p>

<script type="math/tex; mode=display">\text{Duration (seconds)} = \frac{ \text{ Samples Per Frame $\cdot$ Total Frames (samples)} }{ \text{Sample Rate (samples/second)} }</script>

<p>The duration is <strong>not accurate</strong> when the <em>total frames</em> above
is an <strong>estimated</strong> value.
If the total frames isn‚Äôt predefined, then it could be estimated by:</p>

<script type="math/tex; mode=display">\text{Estimated Total Frames} = \frac{ \text{File Size} }{ \text{Average Frame Size} }</script>

<h3 id="live-stream">Live stream</h3>

<p>No matter what type the <em>MP3</em> is encoded with,
the duration is calculated by the <strong>file size</strong>,
but what if the <em>file size</em> is <strong>unknown</strong>?
Before addressing the question, we should ask
what type of media will have an unknown file size.
The answer is <strong>live stream</strong>.</p>

<p>The live stream can be closed anytime,
hence we don‚Äôt need to calculate the duration beforehand.
We just need to make sure the position of the playback
stays at the end of the media track and the end-time keeps increasing.</p>

<p><img src="../images/posts/live-stream-playback.png" alt="" title="live stream playback" />
(The position stays at the end of the media track during streaming.)</p>

<p>However, for those live streams with <strong>opening remark</strong>,
we still need to estimate how long the opening talks will be
and show the playback UI as they are non-live streams
before they finish introducing and start streaming.
After finishing the opening talks,
the UI should behave as the same as they are live streams.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/f53NjLQTafQ" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen=""></iframe>

<p>(You can check this by opening <a href="http://honey.macchiatomedia.org:8080/stream/1/?lang=en-US%2cen%3bq%3d0.5"><em>KHNY Honey 103</em></a> directly,
or go to <a href="https://www.shoutcast.com/">shoutcast</a> and play <em>KHNY Honey 103</em> under Genre <em>Jazz</em>)</p>

<p>As <em>file size</em> is unknown, we should use <a href="https://www.codeproject.com/Articles/8295/MPEG-Audio-Frame-Header#XINGHeader"><em>number of frames</em></a>
(<a href="https://searchfox.org/mozilla-central/rev/f6f1731b1b7fec332f86b55fa40e2c9ae67ac39b/dom/media/mp3/MP3FrameParser.cpp#452,475-479">example</a>)
to calculate the duration of the opening introduction(<a href="https://searchfox.org/mozilla-central/rev/22c55eb7b7e6494a8615a7af3b613ff899d2cdba/dom/media/mp3/MP3Demuxer.cpp#389-395">example</a>).
(The <em>number of frames</em> here is same as the <em>total frames</em> mentioned
in the estimation of <em>VBR MP3</em>‚Äôs duration.)</p>

<p>To sum up this case, the ending time shown on playback at first
should be the duration of the opening talk.
After the playback‚Äôs position reaches the end, it should stay at the end
and the duration should keep increasing during streaming music.</p>

<h4 id="how-to-know-whether-the-file-size-is-unknown">How to know whether the file size is unknown</h4>

<p>Usually, the <em>file size</em> of a live stream will be set to <code class="highlighter-rouge">-1</code>.</p>

<h2 id="sample-code">Sample code</h2>
<ul>
  <li>Duration: <a href="https://searchfox.org/mozilla-central/rev/22c55eb7b7e6494a8615a7af3b613ff899d2cdba/dom/media/mp3/MP3Demuxer.cpp#382-420">MP3Demuxer.cpp</a></li>
  <li>Parsing Header: <a href="https://searchfox.org/mozilla-central/rev/f6f1731b1b7fec332f86b55fa40e2c9ae67ac39b/dom/media/mp3/MP3FrameParser.cpp#548">MP3FrameParser.cpp</a></li>
</ul>

<h2 id="useful-references">Useful References</h2>

<p>These points are the summary of what I‚Äôve learned from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1419736" title="Bug 1419736 - mp3 time length bug">bug 1419736</a>.
You can see more detail there.
It‚Äôs my first bug in demuxer field.
I quickly write a note here in case I need to recall it someday.</p>

<p>The following links are some useful resources I found when
I tried to get into this field:</p>
<ul>
  <li><a href="https://www.codeproject.com/Articles/8295/MPEG-Audio-Frame-Header">MPEG Audio Frame Header</a></li>
  <li><a href="http://www.mp3-tech.org/programmer/frame_header.html">MPEG Audio Layer I/II/III frame header</a></li>
  <li><a href="http://www.mpgedit.org/mpgedit/mpeg_format/mpeghdr.htm">MPEG Audio Compression Basics</a></li>
  <li><a href="http://gabriel.mp3-tech.org/mp3infotag.html">MP3 Info Tag</a></li>
  <li><a href="https://stackoverflow.com/questions/3505575/how-can-i-get-the-duration-of-an-mp3-file-cbr-or-vbr-with-a-very-small-library">How can I get the duration of an MP3 file</a></li>
  <li><a href="https://www.crifan.com/files/doc/docbook/mpeg_vbr/release/webhelp/ch04_xing_vbri.html">MPEGÁ∞°‰ªãËàáÂ¶Ç‰ΩïË®àÁÆóCBRÂèäVBRÁöÑÊí≠ÊîæÊôÇÈñì</a></li>
</ul>

:ET