<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">


<meta name="keywords" content="Firefox">


<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Running Average | Peak Up</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Running Average" />
<meta name="author" content="Chun-Min Chang" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Preventing overflow is essential while calculating the average of a long series of data. One simplest method to avoid the problem is running average (or moving average, rolling average, incremental mean). Problem Suppose we have data . The will overflow when the new data is counted, where . At that time, will be wrong, where is the average of , since is an overflowed value. How could we solve the problem? Naive Approach uint64_t count = 0; uint64_t sum = 0; void Add(uint64_t data) { if (sum + data &lt; sum) { // Overflow! sum = sum / 2; count = count / 2; } sum += data; ++count; } double GetAverage() { return static_cast&lt;double&gt;(sum) / count; } The above approach to prevent overflow is extracted from Gecko MP3Demuxer, but it’s wrong in most cases (it’s only correct when every incoming data is same). For example, if we have and will lead to overflow to the sum of so the average computed by above approach will be , which is different from . I cannot believe this incorrect code lives in Firefox more than 3 years. Fortunately, the overflow happens once in a blue moon so it’s not too much trouble. Proof We can formally prove the above approach is incorrect. Let and be the sum and arithmetic mean of respectively, and be the estimated average from above approach. Since the new incoming data will cause overflow to , so , where and As a result, We could compare and to see if they are equal: Thus, we can clearly see that will be equal to only when . Running Average In fact, the average can be calculated without using the overflowed . Let be the mean of , we can get by : Sample code On this ground, we could correct the code into: double average = 0; uint64_t count = 0; void Add(uint64_t data) { average += (data - average) / ++count; } double GetAverage() { return average; } or double UpdateAverage(uint64_t data) { static double average = 0; static uint64_t count = 0; average += (data - average) / ++count; return average; } or class Averager { public: Averager() : average(0) , count(0) {} ~Averager() {}; void Add(uint64_t data) { average += (data - average) / ++count; } double GetAverage() { return average; } private: double average; uint64_t count; } References Bug 1423834 has been filed for this problem when I found this code in MP3Demuxer. You could find more detail there. The following links are some related resources: Moving average on Wiki Incremental averageing Prevent long running averaging from overflow?" />
<meta property="og:description" content="Preventing overflow is essential while calculating the average of a long series of data. One simplest method to avoid the problem is running average (or moving average, rolling average, incremental mean). Problem Suppose we have data . The will overflow when the new data is counted, where . At that time, will be wrong, where is the average of , since is an overflowed value. How could we solve the problem? Naive Approach uint64_t count = 0; uint64_t sum = 0; void Add(uint64_t data) { if (sum + data &lt; sum) { // Overflow! sum = sum / 2; count = count / 2; } sum += data; ++count; } double GetAverage() { return static_cast&lt;double&gt;(sum) / count; } The above approach to prevent overflow is extracted from Gecko MP3Demuxer, but it’s wrong in most cases (it’s only correct when every incoming data is same). For example, if we have and will lead to overflow to the sum of so the average computed by above approach will be , which is different from . I cannot believe this incorrect code lives in Firefox more than 3 years. Fortunately, the overflow happens once in a blue moon so it’s not too much trouble. Proof We can formally prove the above approach is incorrect. Let and be the sum and arithmetic mean of respectively, and be the estimated average from above approach. Since the new incoming data will cause overflow to , so , where and As a result, We could compare and to see if they are equal: Thus, we can clearly see that will be equal to only when . Running Average In fact, the average can be calculated without using the overflowed . Let be the mean of , we can get by : Sample code On this ground, we could correct the code into: double average = 0; uint64_t count = 0; void Add(uint64_t data) { average += (data - average) / ++count; } double GetAverage() { return average; } or double UpdateAverage(uint64_t data) { static double average = 0; static uint64_t count = 0; average += (data - average) / ++count; return average; } or class Averager { public: Averager() : average(0) , count(0) {} ~Averager() {}; void Add(uint64_t data) { average += (data - average) / ++count; } double GetAverage() { return average; } private: double average; uint64_t count; } References Bug 1423834 has been filed for this problem when I found this code in MP3Demuxer. You could find more detail there. The following links are some related resources: Moving average on Wiki Incremental averageing Prevent long running averaging from overflow?" />
<link rel="canonical" href="http://localhost:4000/post/running-average" />
<meta property="og:url" content="http://localhost:4000/post/running-average" />
<meta property="og:site_name" content="Peak Up" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-12-21T00:00:00+08:00" />
<script type="application/ld+json">
{"headline":"Running Average","dateModified":"2017-12-21T00:00:00+08:00","url":"http://localhost:4000/post/running-average","datePublished":"2017-12-21T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/post/running-average"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/mountain.png"},"name":"Chun-Min Chang"},"author":{"@type":"Person","name":"Chun-Min Chang"},"description":"Preventing overflow is essential while calculating the average of a long series of data. One simplest method to avoid the problem is running average (or moving average, rolling average, incremental mean). Problem Suppose we have data . The will overflow when the new data is counted, where . At that time, will be wrong, where is the average of , since is an overflowed value. How could we solve the problem? Naive Approach uint64_t count = 0; uint64_t sum = 0; void Add(uint64_t data) { if (sum + data &lt; sum) { // Overflow! sum = sum / 2; count = count / 2; } sum += data; ++count; } double GetAverage() { return static_cast&lt;double&gt;(sum) / count; } The above approach to prevent overflow is extracted from Gecko MP3Demuxer, but it’s wrong in most cases (it’s only correct when every incoming data is same). For example, if we have and will lead to overflow to the sum of so the average computed by above approach will be , which is different from . I cannot believe this incorrect code lives in Firefox more than 3 years. Fortunately, the overflow happens once in a blue moon so it’s not too much trouble. Proof We can formally prove the above approach is incorrect. Let and be the sum and arithmetic mean of respectively, and be the estimated average from above approach. Since the new incoming data will cause overflow to , so , where and As a result, We could compare and to see if they are equal: Thus, we can clearly see that will be equal to only when . Running Average In fact, the average can be calculated without using the overflowed . Let be the mean of , we can get by : Sample code On this ground, we could correct the code into: double average = 0; uint64_t count = 0; void Add(uint64_t data) { average += (data - average) / ++count; } double GetAverage() { return average; } or double UpdateAverage(uint64_t data) { static double average = 0; static uint64_t count = 0; average += (data - average) / ++count; return average; } or class Averager { public: Averager() : average(0) , count(0) {} ~Averager() {}; void Add(uint64_t data) { average += (data - average) / ++count; } double GetAverage() { return average; } private: double average; uint64_t count; } References Bug 1423834 has been filed for this problem when I found this code in MP3Demuxer. You could find more detail there. The following links are some related resources: Moving average on Wiki Incremental averageing Prevent long running averaging from overflow?","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Peak Up" />

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
    crossorigin="anonymous">

<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/font-awesome.min.css" />

<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/style.css" />
<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/syntax.css" />


<!--Load Mathjax-->
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
        MathJax.Hub.Config({
            config: ["MMLorHTML.js"],
            extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js"],
            jax: ["input/TeX"],
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                processEscapes: false
            },
            TeX: {
                TagSide: "right",
                TagIndent: ".8em",
                MultLineWidth: "85%",
                equationNumbers: {
                   autoNumber: "AMS",
                },
                unicode: {
                   fonts: "STIXGeneral,'Arial Unicode MS'"
                }
            },
            showProcessingMessages: false
        });
</script>



<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/images/favicons/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/images/favicons/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/favicons/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/favicons/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/favicons/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/favicons/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post-template" itemscope itemtype="http://schema.org/WebPage">

    
<div class="search-wrapper">
    <div class="search-form">
        <input type="text" id="search-input" class="search-field" placeholder="Search...">
        <i id="search-close" class="fa fa-times-circle"></i>
        <h4>Search results</h4>
        <ul id="results-container" class="search-results post-list">
        </ul>
        <!-- /.search-results -->
    </div>
    <!-- /.search-form -->
</div>
<!-- ./search-wrapper -->


<div id="fade"></div>
<a id="slide" class="animated fade">
    <i class="fa fa-bars" aria-hidden="true"></i>
</a>
<aside id="sidebar">
    <nav id="navigation">
        <h2>MENU</h2>
        <hr>
        <ul> 
            <li>
                <a href="http://localhost:4000/"><!-- <i class="fa fa-home"></i>&nbsp;-->Home</a>  </li>
            
            <li>
                <a href="http://localhost:4000/categories"><!-- <i class="fa fa-sitemap"></i>&nbsp;-->Categories</a>  </li>
            
            <li>
                <a href="http://localhost:4000/tags"><!-- <i class="fa fa-tags"></i>&nbsp;-->Tags</a>  </li>
            
            <li><a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss"></i> Feed</a></li>
        </ul>
    </nav>
</aside>


<header id="masthead" class="blog-background overlay align-center align-middle animated from-bottom" style="background-image: url(http://localhost:4000/images/background/yosemite/yosemite-tiny.jpg)"
    itemscope itemtype="http://schema.org/Organization">



    <button class="menu-button animated fade dosearch">
        <i class="fa fa-search"></i>
    </button>



    <div class="inner">
        <div class="container">
            <a class="brand" href="http://localhost:4000/" itemprop="url">
                <img itemprop="logo" src="http://localhost:4000/images/mountain.png" alt="Peak Up Logo" />
                <h1 class="blog-title light" itemprop="name">
                    Peak Up
                </h1>
            </a>
        </div>
    </div>



    <div class="decor-wrapper">
        <svg id="header-decor" class="decor bottom" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">
            <!-- <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
            <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>
            <path class="medium left" d="M0 100 L50 50 L0 33.3" fill="rgba(255,255,255, .3)"></path>
            <path class="medium right" d="M100 100 L50 50 L100 33.3" fill="rgba(255,255,255, .3)"></path>
            <path class="small left" d="M0 100 L50 50 L0 66.6" fill="rgba(255,255,255, .5)"></path>
            <path class="small right" d="M100 100 L50 50 L100 66.6" fill="rgba(255,255,255, .5)"></path> -->
            <path d="M0 99.9 L50 49.9 L100 99.9 L0 99.9" fill="rgba(255,255,255, 1)"></path>
            <path d="M48 52 L50 49 L52 52 L48 52" fill="rgba(255,255,255, 1)"></path>
        </svg>
    </div>

</header>


    <div id="main" class="content" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
        <div class="container">
            <div class="row">
                <article class="post col-md-8 col-md-offset-2 hentry" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
                
                
                
                

                    <header class="post-header entry-header">

                    

                    
                        <h1 class="post-title text-center hyper lighter bordered-bottom entry-title" itemprop="headline">
                        
                            
                        
                        
                        

                        
                            Running Average
                        </h1>
                    

                        <div class="cursive" style="color: #000; font-style:italic;"></div>

                            <div class="post-info text-center small">
                            
                                <span class="entry-date date published updated">
                            
                            
                                    <time datetime="2017-12-21T00:00:00+08:00" class="post-time" itemprop="datePublished">21 Dec 2017</time>
                                </span>
                            

                                in <span class="post-tags">

                            
                                    <a href="http://localhost:4000/categories/index.html#CommonMath" data-toggle="tooltip" title="Other posts from the Common category" rel="tag">Common</a>
                                
                                    &nbsp;&bull;&nbsp;
                                
                            
                                    <a href="http://localhost:4000/categories/index.html#CommonMath" data-toggle="tooltip" title="Other posts from the Math category" rel="tag">Math</a>
                                
                            
                                </span>
                            
                            &nbsp;
                                <span class="post-tags"><i class="fa fa-clock-o"></i>&nbsp;

                            

                            
                                    <span class="time">2.411111111111111</span> minutes read
                            
                                
                            

                                </span>
                            
                            </div>

                    </header>

                    <div class="post-body bordered-bottom" itemprop="description">
                    

                        <p>Preventing overflow is essential
while calculating the average of a long series of data.
One simplest method to avoid the problem is <em>running average</em>
(or <em>moving average</em>, <em>rolling average</em>, <em>incremental mean</em>).</p>

<h2 id="problem">Problem</h2>
<p>Suppose we have data <script type="math/tex">x_1, x_2, \cdots, x_n</script>.
The <script type="math/tex">sum_{n+1}</script> will overflow when the new data <script type="math/tex">x_{n+1}</script> is counted,
where <script type="math/tex">sum_i = x_1 + x_2 + \cdots + x_i</script>.
At that time, <script type="math/tex">\mu_{n+1} = \frac{sum_{n+1}}{n+1}</script> will be wrong,
where <script type="math/tex">\mu_i</script> is the average of <script type="math/tex">x_1, x_2, \cdots, x_i</script>,
since <script type="math/tex">sum_{n+1}</script> is an overflowed value.</p>

<p>How could we solve the problem?</p>

<h2 id="naive-approach">Naive Approach</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint64_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">uint64_t</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sum</span> <span class="o">+</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="n">sum</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Overflow!</span>
    <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">sum</span> <span class="o">+=</span> <span class="n">data</span><span class="p">;</span>
  <span class="o">++</span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="nf">GetAverage</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The above approach to prevent overflow
is extracted from <a href="https://searchfox.org/mozilla-central/rev/f5f1c3f294f89cfd242c3af9eb2c40d19d5e04e7/dom/media/mp3/MP3Demuxer.cpp#709-715,720,728,756-760" title="Wrong calculation for mp3 time length as we prevent overflow">Gecko MP3Demuxer</a>,
but it’s <strong>wrong</strong> in most cases
(it’s only correct when every incoming data is same).
For example, if we have <script type="math/tex">x_1 = 10, x_2 = 20</script>
and <script type="math/tex">x_3 = 90</script> will lead to overflow to the sum of <script type="math/tex">x_i</script>
so the average computed by above approach will be <script type="math/tex">\frac{(10+20)/2 + 90}{2/2 + 1} = 52.5</script>,
which is different from <script type="math/tex">\frac{10 + 20 + 90}{3} = 40</script>.
I cannot believe this incorrect code
lives in Firefox <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1093815">more than 3 years</a>.
Fortunately, the overflow happens once in a blue moon
so it’s not too much trouble.</p>

<h3 id="proof">Proof</h3>
<p>We can formally prove the above approach is incorrect.
Let <script type="math/tex">sum_{k}</script> and <script type="math/tex">\mu_k</script> be the <strong>sum</strong> and <strong>arithmetic mean</strong>
of <script type="math/tex">x_1, x_2, \cdots, x_k</script> respectively, and <script type="math/tex">E_k</script> be the estimated average
from above approach.</p>

<p>Since the new incoming data <script type="math/tex">x_{n+1}</script> will cause overflow to <script type="math/tex">sum_{n+1}</script>, so</p>

<p><script type="math/tex">E_{n+1} = \frac{p + x_{n+1}}{q + 1}</script>
, where
<script type="math/tex">p = \frac{sum_{n}}{2} = \frac{x_1 + x_2 + \cdots + x_n}{2}</script>
and
<script type="math/tex">q = \frac{n}{2}</script></p>

<p>As a result,</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
E_{n+1}
&= \frac{p + x_{n+1}}{q + 1} \\
&= \frac{\frac{x_1 + x_2 + \cdots + x_n}{2} + x_{n+1}}{\frac{n}{2} + 1} \\
&= \frac{\frac{x_1 + x_2 + \cdots + x_n + 2 \cdot x_{n+1}}{2}}{\frac{n + 2}{2}} \\
&= \frac{x_1 + x_2 + \cdots + x_n + 2 \cdot x_{n+1}}{n+2}
\end{align} %]]></script>

<p>We could compare <script type="math/tex">E_{n+1}</script> and <script type="math/tex">\mu_{n+1}</script> to see if they are equal:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
\mu_{n+1}
&= \frac{x_1 + x_2 + \cdots + x_n + x_{n+1}}{n+1} \\
&= \frac{(n+2) \cdot (x_1 + x_2 + \cdots + x_n + x_{n+1})}{(n+1) \cdot (n+2)} \\
&= \frac{(n+1) \cdot (x_1 + x_2 + \cdots + x_n + x_{n+1}) + (x_1 + x_2 + \cdots + x_n + x_{n+1})}{(n+1) \cdot (n+2)}
\\
E_{n+1}
&= \frac{x_1 + x_2 + \cdots + x_n + 2 \cdot x_{n+1}}{n+2} \\
&= \frac{(x_1 + x_2 + \cdots + x_n + x_{n+1}) + x_{n+1}}{n+2} \\
&= \frac{(n+1) \cdot ((x_1 + x_2 + \cdots + x_n + x_{n+1}) + x_{n+1})}{(n+1) \cdot (n+2)} \\
&= \frac{(n+1) \cdot (x_1 + x_2 + \cdots + x_n + x_{n+1}) + (n+1) \cdot x_{n+1}}{(n+1) \cdot (n+2)} \\
&= \frac{(n+1) \cdot (x_1 + x_2 + \cdots + x_n + x_{n+1}) + (\overbrace{x_{n+1} + \cdots + x_{n+1}}^{n+1}))}{(n+1) \cdot (n+2)}
\\
\mu_{n+1} - E_{n+1}
&= \frac{ (x_1 + x_2 + \cdots + x_n + x_{n+1}) - (\overbrace{x_{n+1} + \cdots + x_{n+1}}^{n+1}))}{(n+1) \cdot (n+2)} \\
&= \frac{ (x_1 - x_{n+1}) + (x_2 - x_{n+1}) + \cdots +  (x_n - x_{n+1}) + (x_{n+1} - x_{n+1})}{(n+1) \cdot (n+2)} \\
&= \frac{ (x_1 - x_{n+1}) + (x_2 - x_{n+1}) + \cdots +  (x_n - x_{n+1}) }{(n+1) \cdot (n+2)}
\end{align} %]]></script>

<p>Thus, we can clearly see that
<script type="math/tex">\mu_{n+1}</script> will be equal to <script type="math/tex">E_{n+1}</script>
<strong>only</strong> when <script type="math/tex">x_1 = x_2 = \cdots = x_n = x_{n+1}</script>.</p>

<h2 id="running-average">Running Average</h2>

<p>In fact, the average can be calculated
without using the overflowed <script type="math/tex">sum_{n+1}</script>.
Let <script type="math/tex">\mu_n</script> be the mean of <script type="math/tex">x_1, x_2, \cdots, x_n</script>,
we can get <script type="math/tex">\mu_n</script> by <script type="math/tex">\mu_{n-1}</script>:</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
\mu_n
&= \frac{ \mu_{n-1} \cdot (n-1) + x_n }{ n } \\
&= \frac{ n \cdot \mu_{n-1} + x_n - \mu_{n-1}}{ n } \\
&= \mu_{n-1} + \frac{ x_n - \mu_{n-1} }{ n }
\end{align} %]]></script>

<h3 id="sample-code">Sample code</h3>

<p>On this ground, we could correct the <a href="https://gist.github.com/ChunMinChang/a1d7533859dba59a1701d1d42c29bf82" title="Calculating average without sum">code</a> into:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">double</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">uint64_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">average</span> <span class="o">+=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">/</span> <span class="o">++</span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="nf">GetAverage</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">average</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>or</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">double</span> <span class="nf">UpdateAverage</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="kt">double</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">average</span> <span class="o">+=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">/</span> <span class="o">++</span><span class="n">count</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">average</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>or</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Averager</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Averager</span><span class="p">()</span>
    <span class="o">:</span> <span class="n">average</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">,</span> <span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">{}</span>

  <span class="o">~</span><span class="n">Averager</span><span class="p">()</span> <span class="p">{};</span>

  <span class="kt">void</span> <span class="n">Add</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span> <span class="n">average</span> <span class="o">+=</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">average</span><span class="p">)</span> <span class="o">/</span> <span class="o">++</span><span class="n">count</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">double</span> <span class="n">GetAverage</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">average</span><span class="p">;</span> <span class="p">}</span>

<span class="nl">private:</span>
  <span class="kt">double</span> <span class="n">average</span><span class="p">;</span>
  <span class="kt">uint64_t</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="references">References</h2>

<p><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1423834" title="Bug 1423834 - Wrong calculation for mp3 time length as we prevent overflow">Bug 1423834</a> has been filed for this problem
when I found this code in <a href="https://searchfox.org/mozilla-central/rev/f5f1c3f294f89cfd242c3af9eb2c40d19d5e04e7/dom/media/mp3/MP3Demuxer.cpp#709-715,720,728,756-760" title="Wrong calculation for mp3 time length as we prevent overflow">MP3Demuxer</a>.
You could find more detail there.</p>

<p>The following links are some related resources:</p>
<ul>
  <li><a href="https://en.wikipedia.org/wiki/Moving_average">Moving average on Wiki</a></li>
  <li><a href="https://math.stackexchange.com/questions/106700/incremental-averageing">Incremental averageing</a></li>
  <li><a href="https://stackoverflow.com/questions/3316261/prevent-long-running-averaging-from-overflow">Prevent long running averaging from overflow?</a></li>
</ul>



                        <br>

                    
                    
                        <div class="entry-tags text-center">
                            <i class="fa fa-tags"></i>&nbsp;
                                Tagged with 
                            
                                <a href="http://localhost:4000/tags/index.html#Firefox" data-toggle="tooltip" title="Posts tagged with Firefox" rel="tag">Firefox</a>

                                
                            
                        </div>
                    
                    </div>

                    <footer class="post-footer entry-meta">
                    
                        <div class="post-share text-center">
    <p class="light small">
        Share this post
    </p>
    <ul class="social-mini">
        <li>
            <a href="https://twitter.com/intent/tweet?text=Running+Average%20http://localhost:4000/post/running-average%20via%20&#64;"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" data-toggle="tooltip"
                title="Share on Twitter" itemprop="Twitter">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/post/running-average" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"
                data-toggle="tooltip" title="Share on Facebook" itemprop="Facebook">
                <i class="fa fa-facebook"></i>
            </a>
        </li>
        <li>
            <a href="https://plus.google.com/share?url=http://localhost:4000/post/running-average" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;"
                data-toggle="tooltip" title="Share on Google plus" itemprop="GooglePlus">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
    </ul>
</div>
                    

                        <div class="post-author text-center">
	<img src="http://localhost:4000/images/yosemite.png" alt="Chun-Min Chang's photo" itemprop="image" class="post-avatar img-circle img-responsive" />
	<h4 class="bordered-bottom vcard author" itemprop="author" itemscope itemtype="http://schema.org/Person">
		By <span itemprop="name" class="fn"><a href="http://localhost:4000/about" title="About Chun-Min Chang" itemprop="url">Chun-Min Chang</a></span>
	</h4>
	<p>I am a self-directed learner and a maker who enjoys building products from original ideas.</p>
</div> 
                        
                    
                        <div id="disqus_thread"></div><!-- /#disqus_thread -->
                    
                    </footer>

                </article>
            </div>
        </div>
    </div>

    
<footer id="footer" class="blog-background overlay text-center align-middle animated from-top" style="background-image: url(http://localhost:4000/images/background/yosemite/yosemite-tiny.jpg)">


    <div class="inner">
        <div class="container">
            <ul class="social-icons">
                    
                <li>
                    <a href="https://www.linkedin.com/in/chunminchang" data-toggle="tooltip" title="Chun-Min Chang on LinkedIn" target="_blank">
                        <i class="fa fa-linkedin"></i>
                    </a>
                </li>
                   
                <li>
                    <a href="http://github.com/chunminchang" data-toggle="tooltip" title="Chun-Min Chang on Github" target="_blank">
                        <i class="fa fa-github"></i>
                    </a>
                </li>
                
            </ul>
            <div>
                <a href="http://localhost:4000/about/">Chun-Min Chang</a> &copy; 2020 &bull;
                All rights reserved.
            </div>
            <ul class="menu-items">
                
                <li>
                    
                    <a href="http://localhost:4000/"><i class="fa fa-home"></i>&nbsp;Home</a>&nbsp;&bull;
                    
                </li>
                
                <li>
                    
                    <a href="http://localhost:4000/categories"><i class="fa fa-sitemap"></i>&nbsp;Categories</a>&nbsp;&bull;
                    
                </li>
                
                <li>
                    
                    <a href="http://localhost:4000/tags"><i class="fa fa-tags"></i>&nbsp;Tags</a>&nbsp;&bull;
                    
                </li>
                
                <li><a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss"></i> Feed</a></li>
            </ul>
        </div>
    </div>

    
    <div class="decor-wrapper">
        <svg id="footer-decor" class="decor top" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">
            <!-- <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
            <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>
            <path class="medium left" d="M0 0 L50 50 L0 66.6" fill="rgba(255,255,255, .3)"></path>
            <path class="medium right" d="M100 0 L50 50 L100 66.6" fill="rgba(255,255,255, .3)"></path>
            <path class="small left" d="M0 0 L50 50 L0 33.3" fill="rgba(255,255,255, .5)"></path>
            <path class="small right" d="M100 0 L50 50 L100 33.3" fill="rgba(255,255,255, .5)"></path> -->
            <path d="M0 0 L50 50 L100 0 L0 0" fill="rgba(255,255,255, 1)"></path>
            <path d="M48 48 L50 51 L52 48 L48 48" fill="rgba(255,255,255, 1)"></path>
        </svg>
    </div>
    

</footer>


    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
  crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.12.4.min.js"><\/script>')</script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
  crossorigin="anonymous"></script>

<script type="text/javascript" src="http://localhost:4000/assets/js/plugins/jekyll-search.min.js"></script>
<script type="text/javascript" src="http://localhost:4000/assets/js/plugins/jquery.fitvids.js"></script>
<script type="text/javascript" src="http://localhost:4000/assets/js/plugins/jquery.waypoints.min.js"></script>
<script type="text/javascript" src="http://localhost:4000/assets/js/plugins/jquery.magnific-popup.min.js"></script>
<script type="text/javascript" src="http://localhost:4000/assets/js/main.js"></script>
<script type="text/javascript" src="http://localhost:4000/assets/js/script.js"></script>
<script type='text/javascript'>$(document).ready(function(){$(".time").text(function(a,b){return Math.round(parseFloat(b))})});</script>

<script type="text/javascript">

/*      Slides       */

$("a#slide").click(function(){
    $("#sidebar,body,a#slide,#fade").addClass("slide")
});

$("#fade,#header,#posts-container").click(function(){
    $("#sidebar,body,a#slide,#fade").removeClass("slide")
});

$("a#click-filter").click(function(){
    $("#slide-filter").slideToggle("medium");
    $("#slide-pages").slideOut("medium");
});

$("a#click-pages").click(function(){
    $("#slide-pages").slideToggle("medium");
    $("#slide-filter").slideOut("medium");
});

/*      End-Slides      */

</script>


<!-- Jekyll Simple Search option -->
<script>

   SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: 'http://localhost:4000/assets/json/search.json',
        searchResultTemplate: '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
        noResultsText: '<p>Nothing found.</p>',
        limit: 10,
        fuzzy: false,
        exclude: ['Welcome']
      });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $("#search-close"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


 


<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'chunminchang-blog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        
</body>
</html>
